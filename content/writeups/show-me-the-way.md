---
title: "Show Me the Way"
date: 2024-01-21T20:43:34+01:00
tags: ["CTF","Writeups","HACKDAY 2024 Qualification","Crypto"]
author: "Sirius14"
showToc: true
TocOpen: false
draft: false
hidemeta: false
comments: false
description: "HACKDAY 2024 Qualification Crypto challenge by Chelinka"
disableHLJS: false # to disable highlightjs
disableShare: false
hideSummary: false
searchHidden: true
ShowReadingTime: true
ShowBreadCrumbs: false
ShowPostNavLinks: false
ShowWordCount: false
ShowRssButtonInSectionTermList: false
UseHugoToc: true
pygmentsUseClasses: true
pygmentsCodeFences: true
---

The secret agent 007 gave us a classified file and gave us the means to read it, unfortunately, he could not do it to avoid any suspicion within the Hack107. Decrypt the text in the file to read the flag!

## First look

We have to our disposition 2 files, a part of source code:
{{<highlight txt>}}
def P(x):
	return formula(x)
def Q(x):
	return another_formula(x)

n = P(X)*Q(X)
phi = (P(X)-1)*(Q(X)-1)
e = 0x10001
d = pow(e, -1, phi)

print(n)
def encrypt(pt:str, e, n):
	pt = pt[::-1]
	ct = pow(bytes_to_long(pt.encode()), e, n)
	return ct

def decrypt(ct:int, d, n):
	pt = pow(ct, d, n)
	pt = long_to_bytes(pt).decode()
	return pt[::-1]

flag = input("Que souhaitez-vous chiffrer ? ")
print(encrypt(flag, e, n))
{{</highlight>}}

And output :
{{<highlight txt>}}
C = 2565617200166195847141820928636232303959466722932792435323711473965652085371699818644409256990409854048944273889028395427212647285096620147927751484918108065303000987005428811601509106033544824154004155247749651849388960745201851220865639078232468837572017487899553302561947972350180790337323260039010564873086627329116972503791322926648544263487729211803983796460777700080964480684225095759331029591580667172315329031801221006095830894913366492646106198809678335180404967834014465213071012334463161243798668249316387388896615356529679219334762683987621996735445923292411584267482736997931521981371010250736803883850124086811981296847046184646544341090182005804326034206846831836495437948287344937128613750220151417179776923247572197141730803872869207722489892434431306177467240055054918472090059029917750015977990019074665525769825707485580566711901744843592821082242610459526779285285457758540532197630815918118376169006356119855487579630979321639934789282013802634090104249954889447300640494797136454210084024870216383477122432977329939795881446508639802099815243215786621936463817640047721308586018053015489260037207134192787282389359286090040755235606024014221310785716415247412510214122721056658870318538556573512692

N = 10274622173320909389031395002382723520310683266624262003758324433654540040809219233599998390391541291081480955769558063877739745263628876566148594399190487217520529947703418385797126076202883896285563297412493796455549735516349258737267111485734958124647676862139978578822328063131028977645973314255958832814431129401741363681924246624731580306332996274947224225276913011825249480579351788647303424376829926794897238480915821396590836505557261932201793218787876369479689474390699568395442160695951675495911526788768792712587827140759752600815834201530200102574327547287838813124748635529299343877238787638666002517369183147324348276580386835912162978347500880951405211071469315569907393288673767750500338439908319636060342999154216171420367334387728243762904978917643239586128408102087398429687219613116999755320251996795637299545734755393100528238070409625880097215206538255250563512463977488434914174814989014820102387306536769608806232340706951978003787459755560489338182409731880347246492232556511479625859446872995332197943657987872417697758505073815646447821621770469326686335161275436219144215858159910848423968589115317782429522873529296494028537507162631866445206682695650087594304263021619605307406513658218147729

e = 0x10001
{{</highlight>}}
So we don't have many information or obvious vulnerabilies, however we can observe a relation between P and Q, both depend of X and this could be a good starting point.

## Some tentatives ...

The first idea I came to my mind was a Fermat Attack, indeed as both factor depend of X it might be use the next prime. But it wasn't the good exploit ðŸ˜”.
Another idea was to test every well known attack with [RsaCtfTool](https://github.com/RsaCtfTool/RsaCtfTool), but noting append N is still not factorable.

## ... until the good one

After few days of searching in web other exploits, I wondered whether the creator of this challenge had not been inspired by another CTF challenge ?
I visit a piece of writeups from famous french CTF and I came across an interesting [writeup](https://github.com/HackademINT/404CTF-2023/tree/main/Cryptanalyse/Trois) from 404 CTF using an unknown technique for me.
This explanation clarifies whether the representation of the number N in a different numerical base contains multiple occurrences of 0, then we can transform factorisation problem into polynÃ´me factorisation which is much easier to solve.
I try with the example of base 3, but it doesn't work. I continue with other base until in base 7 I obtain this result:

{{<highlight txt>}}
C=1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000010000000000000001000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000010000000000000000000000000000000000000000000000000000000000331000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000010000110000000000000000000000000000000000000000000010000000000000011000000000000000000000000000000000000000000000000011# in base 3
{{</highlight>}}

Wow so much 0 in it !!!

## PolynÃ´me factorisation

I adapt sage code from this [WU](https://github.com/HackademINT/404CTF-2023/blob/main/Cryptanalyse/Trois/solve.sage), here is the code :

{{<highlight txt>}}
E = GF(7)
R.<X> = PolynomialRing(E)
n_acc = N
P = 0
i = 0

while n_acc > 0:
    P += (n_acc % 7)*X^i
    i += 1
    n_acc = n_acc // 7

RR.<Z> = PolynomialRing(ZZ)
P = RR(P)

assert int(P(7)) == int(n)

p = int(P.factor()[0][0](7))

assert n % p == 0
assert 1 < p < n

print(p)
{{</highlight>}}

Bingo it works !!!

Now we have a factorisation of N we can find the flag:

{{<highlight txt>}}
q = n// p
d = pow(e, -1, (p-1) * (q-1))

pt = pow(C, d, N)
print(bytes.fromhex(hex(pt)[2:]))
{{</highlight>}}

And we obtain : `ajniN eturB - EVE locotorp wolloF - denwp tidnaB SD`
When reverse this result : `DS Bandit pwned - Follow protocol EVE - Brute Ninja`

So flag is : __HACKDAY{EVE}__